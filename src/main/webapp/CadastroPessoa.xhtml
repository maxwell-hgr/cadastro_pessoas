<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="/WEB-INF/template/Layout.xhtml">

    <ui:define name="titulo">Cadastro de Pessoas</ui:define>

    <ui:define name="container">
        <f:metadata>
            <f:viewAction action="#{cadastroPessoaBean.buscarTodos}"/>
        </f:metadata>

        <!-- Altere o primeiro h:form para incluir a tabela também -->
        <h:form id="mainForm">
            <p:messages autoUpdate="true"/>

            <p:toolbar>
                <f:facet name="left">
                    <p:inputText placeholder="Procurar por nome ou cep" size="30" value="#{cadastroPessoaBean.query}"/>
                    <p:commandButton value="Pesquisar" icon="pi pi-search" actionListener="#{cadastroPessoaBean.pesquisar}" update="pessoasDT"/>

                    <span class="ui-separator">
            <span class="ui-icon ui-icon-grip-dotted-vertical" />
        </span>

                    <p:commandButton value="Nova" icon="pi pi-save" onclick="PF('pessoaDialogWidgetVar').show()"/>

                    <span class="ui-separator">
            <span class="ui-icon ui-icon-grip-dotted-vertical" />
        </span>

                    <p:commandButton title="Editar" icon="pi pi-file-edit" />
                    <p:commandButton title="Excluir" icon="pi pi-exclamation-circle" style="background-color: red; border-color: red"/>
                </f:facet>
            </p:toolbar>

            <p:spacer height="10px"/>

            <!-- Movi a tabela para dentro do mesmo formulário -->
            <p:dataTable id="pessoasDT" value="#{cadastroPessoaBean.todos}"
                         var="pessoa" emptyMessage="Nenhuma pessoa encontrada!"
                         paginator="true" rows="10" paginatorPosition="bottom">
                <p:column headerText="Nome" sortBy="#{pessoa.nome}">
                    <h:outputText value="#{pessoa.nome}"/>
                </p:column>
                <p:column headerText="Data de Nascimento">
                    <h:outputText value="#{pessoa.dataNascimento}"/>
                </p:column>
                <p:column headerText="Sexo">
                    <h:outputText value="#{pessoa.genero}"/>
                </p:column>
                <p:column>
                    <h:outputText value="Endereço"/>
                </p:column>
            </p:dataTable>
        </h:form>

        <!-- Mantive o diálogo em um form separado -->
        <h:form>
            <p:dialog header="Cadastrar Pessoa" widgetVar="pessoaDialogWidgetVar" modal="true" resizable="false" closeOnEscape="true">
                <p:panelGrid columns="2" style="width:100%">
                    <p:outputLabel value="Nome:" for="nome"/>
                    <p:inputText id="nome" value="#{cadastroPessoaBean.pessoa.nome}" required="true"/>

                    <p:outputLabel value="Data Nasc.:" for="dataNascimento"/>
                    <p:calendar id="dataNascimento" value="#{cadastroPessoaBean.pessoa.dataNascimento}"
                                pattern="dd/MM/yyyy" locale="pt_BR" required="true"/>

                    <p:outputLabel value="Sexo:" for="sexo"/>
                    <p:selectOneMenu id="sexo" value="#{cadastroPessoaBean.pessoa.genero}" required="true">
                        <f:selectItem itemLabel="Selecione..." itemValue="#{null}"/>
                        <f:selectItems value="#{cadastroPessoaBean.generos}"
                                       var="enumGenero"
                                       itemLabel="#{enumGenero.genero}"
                                       itemValue="#{enumGenero}"/>
                    </p:selectOneMenu>

                    <p:outputLabel value="UF:" for="estado"/>
                    <p:selectOneMenu id="estado" value="#{cadastroPessoaBean.pessoa.endereco.estado}"
                                     required="true">
                        <f:selectItem itemLabel="Selecione..." itemValue="#{null}"/>
                        <f:selectItems value="#{cadastroPessoaBean.estados}"
                                       var="enumEstado"
                                       itemLabel="#{enumEstado.nome}"
                                       itemValue="#{enumEstado}"/>
                    </p:selectOneMenu>

                    <p:outputLabel value="Cidade:" for="cidade"/>
                    <p:inputText id="cidade" value="#{cadastroPessoaBean.pessoa.endereco.cidade}" required="true"/>

                    <p:outputLabel value="Logradouro:" for="logradouro"/>
                    <p:inputText id="logradouro" value="#{cadastroPessoaBean.pessoa.endereco.logradouro}" required="true"/>

                    <p:outputLabel value="Número:" for="numero"/>
                    <p:inputText id="numero" value="#{cadastroPessoaBean.pessoa.endereco.numero}" required="true"/>

                    <p:outputLabel value="CEP:" for="cep"/>
                    <p:inputText id="cep" value="#{cadastroPessoaBean.pessoa.endereco.cep}" required="true">
                    </p:inputText>
                </p:panelGrid>

                <f:facet name="footer">
                    <p:commandButton value="Salvar" action="#{cadastroPessoaBean.salvar}"
                                     update="@form" process="@form"
                                     oncomplete="if(!args.validationFailed) PF('pessoaDialogWidgetVar').hide()"/>
                    <p:commandButton value="Cancelar" onclick="PF('pessoaDialogWidgetVar').hide()"
                                     immediate="true" type="button"/>
                </f:facet>
            </p:dialog>
        </h:form>
    </ui:define>
</ui:composition>